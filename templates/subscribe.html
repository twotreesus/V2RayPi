<div class="mdui-container">
    <p></p>
    <div class="mdui-row">
        <div class="mdui-table-fluid">
            <!-- 订阅列表表格 -->
            <table class="mdui-table">
                <tbody id="subscribe_body">
                <tr>
                    <td colspan="5">
                        <div class="mdui-row" style="width: 100%; display: flex; align-items: center;">
                            <div class="mdui-col-xs-1" style="width: 8%; display: flex; align-items: center;">
                                <strong class="mdui-typo" style="white-space: nowrap;">最近订阅</strong>
                            </div>
                            <div class="mdui-col-xs-3" style="width: 30%; display: flex; align-items: center;">
                                <span id="last_subscribe" style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                            </div>
                            <div class="mdui-col-xs-5" style="display: flex; align-items: center;">
                                <div style="display: flex; gap: 8px; justify-content: flex-start;">
                                    <div id="update_all_subscribe" style="display: none">
                                        <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-accent mdui-ripple" onclick="update_all_subscribe()">全部更新</button>
                                    </div>
                                    <div>
                                        <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-accent mdui-ripple" onclick="add_subscribe()">新增订阅</button>
                                    </div>
                                    <div id="ping_test" style="display: none">
                                        <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-accent mdui-ripple" onclick="ping_test()">ping</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr class="mdui-color-grey-100" style="height: 8px;"><td colspan="5"></td></tr>
                <tr id="subscribe_template" class="mdui-color-light-blue-50" style="display: none">
                    <td colspan="5">
                        <div class="mdui-row" style="width: 100%; display: flex; align-items: center;">
                            <div class="mdui-col-xs-1" style="width: 8%; display: flex; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;" class="toggle-row">
                                    <i class="mdui-icon material-icons group-toggle">expand_more</i>
                                    <strong class="mdui-typo subscribe-index" style="white-space: nowrap;">订阅地址</strong>
                                </div>
                            </div>
                            <div class="mdui-col-xs-6" style="width: 52%; display: flex; align-items: center;">
                                <strong class="url" style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></strong>
                            </div>
                            <div class="mdui-col-xs-5" style="width: 23%; display: flex; align-items: center;">
                                <div style="display: flex; gap: 8px; justify-content: flex-start;">
                                    <div>
                                        <button class="copy_url mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-accent mdui-ripple" mdui-tooltip="{'content': '复制订阅地址'}">复制</button>
                                    </div>
                                    <div>
                                        <button class="update_subscribe mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-accent mdui-ripple">更新</button>
                                    </div>
                                    <div>
                                        <button class="remove_subscribe mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-red-400 mdui-ripple">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr id="manual_template" class="mdui-color-light-blue-50" style="display: none">
                    <td colspan="5">
                        <div class="mdui-row" style="width: 100%; display: flex; align-items: center;">
                            <div class="mdui-col-xs-1" style="width: 8%; display: flex; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;" class="toggle-row">
                                    <i class="mdui-icon material-icons group-toggle" data-group="manual">expand_more</i>
                                    <strong class="mdui-typo subscribe-index" style="white-space: nowrap;">手动节点</strong>
                                </div>
                            </div>
                            <div class="mdui-col-xs-6" style="width: 52%; display: flex; align-items: center;">
                                <strong style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></strong>
                            </div>
                            <div class="mdui-col-xs-5" style="width: 23%; display: flex; align-items: center;">
                                <div style="display: flex; gap: 8px; justify-content: flex-start;">
                                    <div>
                                        <button class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-accent mdui-ripple" onclick="add_manual_node()">添加</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
            
            <!-- 节点列表表格 -->
            <table class="mdui-table" style="margin-top: 8px;">
                <tbody id="node_list_body">
                <tr id="node_header_template" class="mdui-typo-caption-opacity" style="display: none">
                    <td style="width: 8%;">序号</td>
                    <td style="width: 37%;">名称</td>
                    <td style="width: 30%;">地址</td>
                    <td style="width: 10%;">延迟</td>
                    <td style="width: 15%;">操作</td>
                </tr>
                <tr id="node_template" style="display: none">
                    <td class="node_index"></td>
                    <td class="node_name"></td>
                    <td class="node_addr"></td>
                    <td class="node_delay"></td>
                    <td>
                        <div style="display: flex; gap: 8px; justify-content: flex-start;">
                            <div class="mdui-chip apply_node" title="应用节点">
                                <span class="mdui-chip-icon mdui-color-green-500"><i class="mdui-icon material-icons">check</i></span>
                            </div>
                            <div class="mdui-chip get_node_link" title="拷贝链接">
                                <span class="mdui-chip-icon mdui-color-blue-500"><i class="mdui-icon material-icons">links</i></span>
                            </div>
                            <div class="mdui-chip get_node_qr" title="获取二维码">
                                <span class="mdui-chip-icon mdui-color-grey-500"><i class="mdui-icon material-icons">border_outer</i></span>
                            </div>
                            <div class="mdui-chip delete_node" title="删除节点">
                                <span class="mdui-chip-icon mdui-color-red-500"><i class="mdui-icon material-icons">delete</i></span>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <p></p>
</div>

<div id="qr_toast" class="mdui-dialog">
    <div class="mdui-dialog-content">
        <div id="qr_code" style="width: fit-content"></div>
    </div>
</div>

<style>
    .node_running {
        position: relative;
    }
    .node_running::after {
        content: '';
        position: absolute;
        top: 4px;
        left: 4px;
        right: 4px;
        bottom: 4px;
        background: rgba(76, 175, 80, 0.15);
        border-radius: 8px;
        pointer-events: none;
    }
    .node_running td.node_name {
        text-align: left;
    }
    .node_running .node_name .node-name-text {
        display: inline-block;
        background-color: #4CAF50;
        color: white;
        padding: 4px 8px;
        margin-left: -8px;
        border-radius: 4px;
    }
    .node_running .apply_node .mdui-chip-icon {
        color: white !important;
        background-color: #FF9800 !important;
    }
    .subscribe-index {
        display: inline-block;
        background-color: rgba(0, 0, 0, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.3s ease;
    }
    .subscribe-index.running {
        background-color: #4CAF50;
        color: white !important;
    }
    .url {
        margin-left: 24px;
    }
    .node-type-badge {
        display: inline-block;
        font-size: 10px;
        font-weight: 600;
        line-height: 1;
        padding: 1px 4px;
        border-radius: 3px;
        border: 1px solid;
        margin-right: 6px;
        vertical-align: middle;
    }
    .node-type-vmess {
        color: #1976d2;
        border-color: #1976d2;
        background-color: rgba(25, 118, 210, 0.08);
    }
    .node-type-vless {
        color: #7b1fa2;
        border-color: #7b1fa2;
        background-color: rgba(123, 31, 162, 0.08);
    }
</style>

<script src="/static/js/qrcode.js"></script>
<script src="/static/js/jquery.qrcode.js"></script>
<script type="text/javascript">
    //# sourceURL=subscribe.js
    var nodeGroups = {};
    
    $(document).ready(function () {
        mdui.mutation();
        refresh();
    });

    function refresh() {
        ajax_request({ url: "/subscribe_list" }).then(function (subscribe) {
            $("#last_subscribe").html(subscribe["last_subscribe"]);
            var groups = Object.values(subscribe["subscribes"]);
            if (groups.length === 0) {
                $("#update_all_subscribe").hide();
                $("#ping_test").hide();
            }
            else {
                $("#update_all_subscribe").show();
                $("#ping_test").show();
            }

            $("tr[id^='real_subscribe']").remove();
            $("tr[id^='real_header']").remove();
            $("tr[id^='real_node']").remove();
            $("tr[id^='real_manual']").remove();

            var node_running = subscribe["ps"];
            var tbody = $("tbody");

            function make_group_head(url, index) {
                var url_row = $("#subscribe_template").clone();
                url_row.find(".url").html(url);
                url_row.find(".subscribe-index").html("订阅 " + index.toString());
                url_row.attr("id", "real_subscribe_" + index.toString());
                url_row.find(".group-toggle").attr("data-group", index);
                tbody.append(url_row);
                url_row.show();
            }

            function make_manual_head() {
                var manual_head = $("#manual_template").clone();
                manual_head.attr("id", "real_manual");
                tbody.append(manual_head);
                manual_head.show();
            }

            function make_node_head(index) {
                var node_head_row = $("#node_header_template").clone();
                node_head_row.attr("id", "real_header_" + index.toString());
                node_head_row.addClass("group-" + index);
                $("#node_list_body").append(node_head_row);
                node_head_row.hide();
            }
            
            function make_node_row(url, node_data, group_index, node_index) {
                var node_row = $("#node_template").clone();
                node_row.attr("id", "real_node_" + group_index.toString() + "_" + node_index.toString());
                node_row.attr("url", url);
                node_row.attr("data-url", url);
                node_row.attr("data-index", node_index - 1);
                node_row.addClass("group-" + group_index);
                node_row.find(".node_index").html(node_index.toString());
                var protocol = (node_data["protocol"] || "vmess").toLowerCase();
                var typeBadge = '<span class="node-type-badge node-type-' + protocol + '">' + protocol + '</span>';
                node_row.find(".node_name").attr("data-ps", node_data["ps"]).html(typeBadge + ' <span class="node-name-text">' + node_data["ps"] + '</span>');
                node_row.find(".node_addr").html(node_data["add"]);
                if (node_data["ps"] === node_running) {
                    node_row.addClass("node_running");
                    node_row.find(".apply_node .mdui-icon").html("vpn_key");
                }

                $("#node_list_body").append(node_row);
                // Initially show all nodes
                node_row.show();
                $(".group-" + group_index).show();
                $("#subscribe_group_" + group_index + " .group-toggle").text("expand_less");
            }

            function bind_node_row_event() {
                // Bind toggle event
                $(".toggle-row").off("click").on("click", function() {
                    var $row = $(this);
                    var $icon = $row.find(".group-toggle");
                    var group = $icon.attr("data-group");
                    var groupIndex = group === "manual" ? (groups.length + 1).toString() : $row.closest("tr").attr("id").split("_")[2];
                    var $nodes = $(".group-" + groupIndex);
                    
                    if ($nodes.first().is(":visible")) {
                        $nodes.hide();
                        $icon.text("expand_more");
                    } else {
                        $nodes.show();
                        $icon.text("expand_less");
                    }
                    
                    return false;
                });

                $(".update_subscribe").click(function () {
                    var url = $(this).closest("tr").find(".url").text();
                    update_subscribe(url);
                })

                $(".remove_subscribe").click(function () {
                    var url = $(this).closest("tr").find(".url").text();
                    remove_subscribe(url);
                })

                $(".copy_url").click(function () {
                    var url = $(this).closest("tr").find(".url").text();
                    if (copy_to_clipboard(url)) {
                        message("订阅地址已复制");
                    }
                })

                $(".apply_node").click(function () {
                    var row = $(this).closest("tr");
                    var url = row.attr("url");
                    var node_index = parseInt(row.find(".node_index").text()) - 1;
                    apply_node(url, node_index);
                });

                $(".get_node_link").click(function () {
                    var row = $(this).closest("tr");
                    var url = row.attr("url");
                    var node_index = parseInt(row.find(".node_index").text()) - 1;
                    get_node_link(url, node_index);
                })

                $(".get_node_qr").click(function () {
                    var row = $(this).closest("tr");
                    var url = row.attr("url");
                    var node_index = parseInt(row.find(".node_index").text()) - 1;
                    get_node_qr(url, node_index);
                })

                $(".delete_node").click(function () {
                    var row = $(this).closest("tr");
                    var url = row.attr("url");
                    var node_index = parseInt(row.find(".node_index").text()) - 1;
                    delete_node(url, node_index);
                })
            }

            // Clear existing node groups
            nodeGroups = {};
            
            // main
            groups.forEach(function (group) {
                var url = group["subscribe"];
                var i = groups.indexOf(group);
                var index = i + 1;
                
                make_group_head(url, index);
                make_node_head(index);

                var node_list = group["nodes"];
                node_list.forEach(function(node_data){
                    var j = node_list.indexOf(node_data);
                    make_node_row(url, node_data, index, j + 1);
                });
            })

            make_manual_head();
            var manuals = subscribe["manual_nodes"];
            if (manuals.length > 0) {
                make_node_head(groups.length + 1);
                manuals.forEach(function (node_data) {
                    var j = manuals.indexOf(node_data);
                    make_node_row('manual', node_data, groups.length + 1, j + 1);
                })
            }

            // Ensure events are bound after all DOM elements are created
            setTimeout(function() {
                bind_node_row_event();
                update_ping_result();
                
                // Update group title style
                if (node_running) {
                    var runningNode = $(".node_running");
                    if (runningNode.length > 0) {
                        var nodeUrl = runningNode.attr("url");
                        if (nodeUrl === 'manual') {
                            $("#real_manual .subscribe-index").addClass("running");
                        } else {
                            var groupRow = $("tr[id^='real_subscribe_']").filter(function() {
                                return $(this).find(".url").text() === nodeUrl;
                            });
                            if (groupRow.length > 0) {
                                groupRow.find(".subscribe-index").addClass("running");
                            } else {
                                $("#real_manual .subscribe-index").addClass("running");
                            }
                        }
                    }
                }
            }, 100);
        });
    }
    
    function apply_node(url, index) {
        pop_toast("正在应用节点...")
        ajax_request({ url: "/apply_node", data: {subscribe:url, node_index:index} }).then(function (data) {
            if (check_result(data)) {
                update_toast("应用成功");
                // Update node status
                var prev_running = $(".node_running");
                prev_running.removeClass("node_running");
                prev_running.find(".apply_node .mdui-icon").html("check");
                $(".subscribe-index").removeClass("running");
                
                // Update current node
                var current_node = $("tr[data-url='"+url+"'][data-index='"+index+"']");
                current_node.addClass("node_running");
                current_node.find(".apply_node .mdui-icon").html("vpn_key");
                
                // Update group title
                if (url === "manual") {
                    $("#real_manual .subscribe-index").addClass("running");
                } else {
                    var groupRow = $("tr[id^='real_subscribe_']").filter(function() {
                        return $(this).find(".url").text() === url;
                    });
                    groupRow.find(".subscribe-index").addClass("running");
                }
            }
            else {
                update_toast("应用失败");
            }
        }).always(function () {
            close_toast();
        });
    }
    
    function get_node_link(url, index) {
        ajax_request({ url: "/get_node_link", data: {subscribe:url, node_index:index} }).then(function (data) {
            if (check_result(data)) {
                link = data["node_link"];
                copy_to_clipboard(link);
                message("链接已复制到剪贴板");
            }
        })
    }

    function get_node_qr(url, index) {
        ajax_request({ url: "/get_node_link", data: {subscribe:url, node_index:index} }).then(function (data) {
            if (check_result(data)) {
                link = data["node_link"];

                $("#qr_code").empty().qrcode(link);
                toast = new mdui.Dialog("#qr_toast", { destroyOnClosed:true });
                toast.open();
                mdui.mutation();
            }
        })
    }

    function delete_node(url, index) {
        mdui.confirm("确认删除？", function () {
            ajax_request({ url: "/delete_node", data: {subscribe:url, node_index:index} }).then(function (data) {
                if (check_result(data)) {
                    message("节点已删除");
                    refresh();
                }
            })
        });
    }

    function update_subscribe(url) {
        pop_toast("正在更新订阅节点...")
        ajax_request({ url: "/update_subscribe", data: {subscribe:url} }).then(function (data) {
            if (check_result(data)) {
                update_toast("更新成功");
            }
            else {
                update_toast("更新失败");
            }
        }).always(function () {
            close_toast();
            refresh();
        });
    }

    function update_all_subscribe() {
        pop_toast("正在更新订阅节点...")
        ajax_request({ url: "/update_all_subscribe" }).then(function (data) {
            if (check_result(data)) {
                update_toast("更新成功");
            }
            else {
                update_toast("更新失败");
            }
        }).always(function () {
            close_toast();
            refresh();
        });
    }

    function add_subscribe() {
        mdui.prompt("请输入订阅地址：", function (url) {
            if (!url.length) {
                return;
            }
            pop_toast("正在订阅新的节点列表...");
            ajax_request({ url: "/add_subscribe", data: {subscribe:url} }).then(function (data) {
                if (check_result(data)) {
                    update_toast("订阅成功");
                }
                else {
                    update_toast("订阅失败");
                }
            }).always(function () {
                close_toast();
                refresh();
            });
        });
    }

    function add_manual_node() {
        mdui.prompt("请输入节点链接（vmess:// 或 vless://）：", function (url) {
            if (!url.length) {
                return;
            }
            message("正在添加新的节点列表...");
            ajax_request({ url: "/add_manual_node", data: {url:url} }).then(function (data) {
                if (check_result(data)) {
                    message("添加成功");
                }
                else {
                    message("添加失败");
                }
            }).always(function () {
                refresh();
            });
        });
    }

    function remove_subscribe(url) {
        mdui.confirm("确认删除？", function () {
            ajax_request({ url: "/remove_subscribe", data: {subscribe:url} }).then(function (data) {
                if (check_result(data)) {
                    message("订阅已删除");
                    refresh();
                }
            })
        });
    }

    function ping_test() {
        message("正在测试，请稍候...")
        ajax_request({ url: "/subscribe_ping_all" }).then(function (data) {
            window.g_ping_cache = data["groups"];
            update_ping_result();
            message("测试完成")
        });
    }

    function update_ping_result() {
        if (window.g_ping_cache === undefined)
            return;
        window.g_ping_cache.forEach(function (group) {
            list = group["nodes"];
            url = group["subscribe"];
            $("tbody").find(`tr[url='${url}']`).each(function (index, row) {
                node_name = $(row).find(".node_name").attr("data-ps");
                delay = list[node_name];

                td = $(row).find(".node_delay");
                td.removeClass("mdui-text-color-red");
                td.removeClass("mdui-text-color-green");

                var content = "";
                if (delay !== undefined) {
                    if (-1 === delay) {
                        content = "☹";
                        td.addClass("mdui-text-color-red");
                    }
                    else {
                        content = String(delay) + " ms";
                        td.addClass("mdui-text-color-green");
                    }
                }

                td.html(content);
            });
        });
    }
</script>